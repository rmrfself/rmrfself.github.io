<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>JVM内部机制(一)加载字节码</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>
    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/prism.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-markdown.min.js"></script>
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>
    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="Learn, Innovate, Share - Business Based Vision." />
    <link rel="shortcut icon" href="http://localhost:4000/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="http://localhost:4000/jvm-class-loader" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="张庆华的个人日志" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="JVM内部机制(一)加载字节码" />
    <meta property="og:description" content="How to load classfile ? # What ? Why ? When? How ? public static void main(String[] args) { int a; System.out.println(a); } 在网上已经有很多文章讨论JVM, 以下是讲解JVM构成和运行机理的文章链接: Java Language and Virtual Machine Specifications Java bytecode Understanding JVM Internals The Architecture of the Java Virtual Machine 为啥别读HotSpot VM的源码 图片来源 History View 在考察一项技术前,习惯查看一下它的history。因为从History里面能观察到一件事情的发展痕迹,它又不受当前环境的约束,很享受这个过程。 而且从历史信息中,你还可以了解到相关联的人、事、物,以及它们体现出来的价值观。" />
    <meta property="og:url" content="http://localhost:4000/jvm-class-loader" />
    <meta property="og:image" content="http://localhost:4000/assets/images/spring_java8.png" />
    <meta property="article:publisher" content="https://www.facebook.com/rmrfself" />
    <meta property="article:author" content="https://www.facebook.com/rmrfself" />
    <meta property="article:published_time" content="2016-01-15T23:25:35+08:00" />
    <meta property="article:modified_time" content="2016-01-15T23:25:35+08:00" />
    <meta property="article:tag" content="Jvm" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="JVM内部机制(一)加载字节码" />
    <meta name="twitter:description" content="How to load classfile ? # What ? Why ? When? How ? public static void main(String[] args) { int a; System.out.println(a); } 在网上已经有很多文章讨论JVM, 以下是讲解JVM构成和运行机理的文章链接: Java Language and Virtual Machine Specifications Java bytecode Understanding JVM Internals The Architecture of the Java Virtual Machine 为啥别读HotSpot VM的源码 图片来源 History View 在考察一项技术前,习惯查看一下它的history。因为从History里面能观察到一件事情的发展痕迹,它又不受当前环境的约束,很享受这个过程。 而且从历史信息中,你还可以了解到相关联的人、事、物,以及它们体现出来的价值观。" />
    <meta name="twitter:url" content="http://localhost:4000/" />
    <meta name="twitter:image" content="http://localhost:4000/assets/images/spring_java8.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="张庆华的个人日志" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Jvm" />
    <meta name="twitter:site" content="@rmrfself" />
    <meta name="twitter:creator" content="@rmrfself" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "张庆华的个人日志",
        "logo": "http://localhost:4000/assets/images/blog-icon.svg"
    },
    "url": "http://localhost:4000/jvm-class-loader",
    "image": {
        "@type": "ImageObject",
        "url": "http://localhost:4000/assets/images/spring_java8.png",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://localhost:4000/jvm-class-loader"
    },
    "description": "How to load classfile ? # What ? Why ? When? How ? public static void main(String[] args) { int a; System.out.println(a); } 在网上已经有很多文章讨论JVM, 以下是讲解JVM构成和运行机理的文章链接: Java Language and Virtual Machine Specifications Java bytecode Understanding JVM Internals The Architecture of the Java Virtual Machine 为啥别读HotSpot VM的源码 图片来源 History View 在考察一项技术前,习惯查看一下它的history。因为从History里面能观察到一件事情的发展痕迹,它又不受当前环境的约束,很享受这个过程。 而且从历史信息中,你还可以了解到相关联的人、事、物,以及它们体现出来的价值观。"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="JVM内部机制(一)加载字节码" href="/feed.xml" />

</head>
<body class="distribution">
    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->
<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->
<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="http://localhost:4000/"><img src="/assets/images/blog-icon.svg" alt="张庆华的个人日志" /></a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">主页</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">关于Mike</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link social-link-fb" href="https://facebook.com/rmrfself" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>
</a>
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/rmrfself" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>
<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->
<main id="site-main" class="site-main outer" role="main">
    <div class="inner">
        <article class="post-full  ">
            <header class="post-full-header">
                <h1 class="post-full-title">JVM内部机制(一)加载字节码</h1>
                <section class="post-full-meta">
                    
                        <span class="date-divider">分类: </span>
                        
                            
                               <a href='/tag/jvm/'>JVM</a>
                            
                        
                    
                    <span class="date-divider">发布于: </span><time class="post-full-meta-date" datetime="15 January 2016">2016-01-15 23:25</time>
                </section>
            </header>
            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>How to load classfile ?</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    # What ? Why ? When? How ? 
    public static void main(String[] args) {
        int a;
        System.out.println(a);
    }

</code></pre></div></div>

<p>在网上已经有很多文章讨论JVM, 以下是讲解JVM构成和运行机理的文章链接:</p>

<p><a href="https://docs.oracle.com/javase/specs/">Java Language and Virtual Machine Specifications</a></p>

<p><a href="https://en.wikipedia.org/wiki/Java_bytecode">Java bytecode</a></p>

<p><a href="https://www.cubrid.org/blog/understanding-jvm-internals">Understanding JVM Internals</a></p>

<p><a href="https://www.artima.com/insidejvm/ed2/jvm2.html">The Architecture of the Java Virtual Machine</a></p>

<p><a href="https://www.slideshare.net/RednaxelaFX/hotspot-vm20120303">为啥别读HotSpot VM的源码</a></p>

<p><img src="http://blog.h5tube.com/a1ec08fa513d2697ec074f9c5efbb2fb4216d81f.jpg" alt="JVM的本质" title="自动机" /></p>

<p><a href="https://know.baidu.com/question/bb368a7cccaffc07649a794ae6e944e5ff6dd61">图片来源</a></p>

<h2 id="history-view">History View</h2>

<p>在考察一项技术前,习惯查看一下它的history。因为从History里面能观察到一件事情的发展痕迹,它又不受当前环境的约束,很享受这个过程。 而且从历史信息中,你还可以了解到相关联的人、事、物,以及它们体现出来的价值观。</p>

<p>拿Java来说, 它的价值观是WORA(Write Once, Run Anywhere)。</p>

<p>因为它的这个价值取向,他的基本架构以及相关的服务衍生全部基于这个方向。</p>

<p>很多人拿java和C++比,和其他语言比,其实没有什么意义。它的设计目标不仅仅是在语言或者系统指令层面, 它的价值观是平台无关性。</p>

<p>在JVM中,系统指令由字节码动态生成。 至于java源文件,可以简单的理解为排版工具。</p>

<p>看下Java历史上的关键时间点</p>

<p>1991年4月,有james gosling博士领导的绿色计划(green project),名字叫OAK, 是不是很酷？ 它是java的前身。</p>

<p>2002年是java很重要的年份, 这一年java被大厂商一致性认可。同时这一年.net发布</p>

<p>2006年, sun 宣布开源java,并成立OpenJdk组织来维护代码。 在jdk1.7中,除了引用头文件和注释之外,其他部分两者基本一样。</p>

<p>2009年,oracle 收购java。</p>

<h2 id="基础准备部分">基础准备部分</h2>

<h3 id="对字节byte的理解">对字节(byte)的理解</h3>

<p>字节(Byte)是理解JVM内存模型的非常容易被忽略却很重的概念,它是JVM内存空间最基本的度量单位。</p>

<p>看一个例子</p>

<blockquote>
  <p>int[] foo = new int[1000000];</p>
</blockquote>

<p>1 sizeof(int) == 4 * sizeof(byte), foo == 4M byte</p>

<p>对比</p>

<blockquote>
  <p>byte[] foo = new byte[1000000];</p>
</blockquote>

<p>foo == 1M byte, 节省了3/4的内存</p>

<p>除了节省存储之外,还存在一个80/20原则。</p>

<p>生活中大部分信息,比如字母、汉字、可以直观感受的信息,”80%”可以用8位bit来表示。</p>

<p>使用byte可以轻松的表达其他类型, 不包括小数类型。浮点类型在JVM中有专门的实现。</p>

<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
      <th>Size</th>
      <th>Example Literals</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>boolean</td>
      <td>true or false</td>
      <td>false</td>
      <td>1 bit</td>
      <td>true, false</td>
    </tr>
    <tr>
      <td>byte</td>
      <td>twos complement integer</td>
      <td>0</td>
      <td>1 byte</td>
      <td>(none)</td>
    </tr>
    <tr>
      <td>char</td>
      <td>Unicode character</td>
      <td>\u0000</td>
      <td>2 bytes</td>
      <td>‘a’, ‘\u0041’, ‘\101’,’\’, ‘'’, ‘\n’, ‘ß’</td>
    </tr>
    <tr>
      <td>short</td>
      <td>twos complement integer</td>
      <td>0</td>
      <td>2 bytes</td>
      <td>(none)</td>
    </tr>
    <tr>
      <td>int</td>
      <td>twos complement integer</td>
      <td>0</td>
      <td>4 bytes</td>
      <td>-2, -1, 0, 1, 2</td>
    </tr>
    <tr>
      <td>long</td>
      <td>twos complement integer</td>
      <td>0</td>
      <td>8 bytes</td>
      <td>-2L, -1L, 0L, 1L, 2L</td>
    </tr>
    <tr>
      <td>float</td>
      <td>IEEE 754 floating point</td>
      <td>0.0</td>
      <td>4 bytes</td>
      <td>1.23e100f, -1.23e-100f, .3f, 3.14F</td>
    </tr>
    <tr>
      <td>double</td>
      <td>IEEE 754 floating point</td>
      <td>0.0</td>
      <td>8 bytes</td>
      <td>1.23456e300d, -1.23456e-300d, 1e1d</td>
    </tr>
  </tbody>
</table>

<p>IEEE-754对浮点数有巧妙的定义,可参考<a href="https://www.diycode.cc/topics/680">IEEE-754 浮点数标准与 Java 实现</a></p>

<p>潜在的问题是，为什么clsassfile要设计成这个结构?</p>

<p>答案是为了保持上层结构的一致性。</p>

<h3 id="java中的字节文件classfile">Java中的字节文件(classfile)</h3>

<p>看一个简单的类</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">t1_1</span><span class="p">;</span>

<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">HashMap</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">Map</span><span class="p">;</span>

<span class="p">/**</span>
 <span class="p">*</span>
 <span class="p">*</span> <span class="p">@</span><span class="n">author</span> <span class="n">zhangqinghua</span>
 <span class="p">*/</span>
<span class="k">public</span> <span class="n">class</span> <span class="n">T1_1</span> <span class="p">{</span>
    <span class="p">/**</span>
     <span class="p">*</span> <span class="p">@</span><span class="n">param</span> <span class="n">args</span> <span class="n">the</span> <span class="nf">command</span> <span class="n">line</span> <span class="n">arguments</span>
     <span class="p">*/</span>
    <span class="k">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="k">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">//</span> <span class="n">TODO</span> <span class="n">code</span> <span class="n">application</span> <span class="n">logic</span> <span class="n">here</span>
        <span class="n">long</span> <span class="n">time</span> <span class="p">=</span> <span class="nf">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">();</span>
        <span class="n">HashMap</span><span class="p">&lt;</span><span class="k">String</span><span class="p">,</span><span class="k">String</span><span class="p">&gt;</span> <span class="n">hm</span> <span class="p">=</span> <span class="n">new</span> <span class="n">HashMap</span><span class="p">&lt;</span><span class="k">String</span><span class="p">,</span><span class="k">String</span><span class="p">&gt;();</span>
        <span class="n">hm</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"now"</span><span class="p">,</span> <span class="s2">"bar"</span><span class="p">);</span>
        <span class="n">Map</span><span class="p">&lt;</span><span class="k">String</span><span class="p">,</span><span class="k">String</span><span class="p">&gt;</span> <span class="n">m</span> <span class="p">=</span> <span class="n">hm</span><span class="p">;</span>
        <span class="n">m</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">,</span> <span class="s2">"baz"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>
<p>带调试信息编译</p>

<blockquote>
  <p>javac -g T1_1.java</p>
</blockquote>

<p>classfile通过<a href="https://github.com/stef-levesque/vscode-hexdump">vscode-hexdump</a>输出以后,直观感受如下:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Offset: 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 	
00000000: CA FE BA BE 00 00 00 34 00 27 0A 00 0C 00 15 0A    J~:&gt;...4.'......
00000010: 00 16 00 17 07 00 18 0A 00 03 00 15 08 00 19 08    ................
00000020: 00 1A 0A 00 03 00 1B 08 00 1C 08 00 1D 0B 00 1E    ................
00000030: 00 1B 07 00 1F 07 00 20 01 00 06 3C 69 6E 69 74    ...........&lt;init
00000040: 3E 01 00 03 28 29 56 01 00 04 43 6F 64 65 01 00    &gt;...()V...Code..
00000050: 0F 4C 69 6E 65 4E 75 6D 62 65 72 54 61 62 6C 65    .LineNumberTable
00000060: 01 00 04 6D 61 69 6E 01 00 16 28 5B 4C 6A 61 76    ...main...([Ljav
00000070: 61 2F 6C 61 6E 67 2F 53 74 72 69 6E 67 3B 29 56    a/lang/String;)V
00000080: 01 00 0A 53 6F 75 72 63 65 46 69 6C 65 01 00 09    ...SourceFile...
00000090: 54 31 5F 31 2E 6A 61 76 61 0C 00 0D 00 0E 07 00    T1_1.java.......
000000a0: 21 0C 00 22 00 23 01 00 11 6A 61 76 61 2F 75 74    !..".#...java/ut
000000b0: 69 6C 2F 48 61 73 68 4D 61 70 01 00 03 6E 6F 77    il/HashMap...now
000000c0: 01 00 03 62 61 72 0C 00 24 00 25 01 00 03 66 6F    ...bar..$.%...fo
000000d0: 6F 01 00 03 62 61 7A 07 00 26 01 00 09 74 31 5F    o...baz..&amp;...t1_
000000e0: 31 2F 54 31 5F 31 01 00 10 6A 61 76 61 2F 6C 61    1/T1_1...java/la
000000f0: 6E 67 2F 4F 62 6A 65 63 74 01 00 10 6A 61 76 61    ng/Object...java
00000100: 2F 6C 61 6E 67 2F 53 79 73 74 65 6D 01 00 11 63    /lang/System...c
00000110: 75 72 72 65 6E 74 54 69 6D 65 4D 69 6C 6C 69 73    urrentTimeMillis
00000120: 01 00 03 28 29 4A 01 00 03 70 75 74 01 00 38 28    ...()J...put..8(
00000130: 4C 6A 61 76 61 2F 6C 61 6E 67 2F 4F 62 6A 65 63    Ljava/lang/Objec
00000140: 74 3B 4C 6A 61 76 61 2F 6C 61 6E 67 2F 4F 62 6A    t;Ljava/lang/Obj
00000150: 65 63 74 3B 29 4C 6A 61 76 61 2F 6C 61 6E 67 2F    ect;)Ljava/lang/
00000160: 4F 62 6A 65 63 74 3B 01 00 0D 6A 61 76 61 2F 75    Object;...java/u
00000170: 74 69 6C 2F 4D 61 70 00 21 00 0B 00 0C 00 00 00    til/Map.!.......
00000180: 00 00 02 00 01 00 0D 00 0E 00 01 00 0F 00 00 00    ................
00000190: 1D 00 01 00 01 00 00 00 05 2A B7 00 01 B1 00 00    .........*7..1..
000001a0: 00 01 00 10 00 00 00 06 00 01 00 00 00 0F 00 09    ................
000001b0: 00 11 00 12 00 01 00 0F 00 00 00 51 00 03 00 05    ...........Q....
000001c0: 00 00 00 25 B8 00 02 40 BB 00 03 59 B7 00 04 4E    ...%8..@;..Y7..N
000001d0: 2D 12 05 12 06 B6 00 07 57 2D 3A 04 19 04 12 08    -....6..W-:.....
000001e0: 12 09 B9 00 0A 03 00 57 B1 00 00 00 01 00 10 00    ..9....W1.......
000001f0: 00 00 1A 00 06 00 00 00 15 00 04 00 16 00 0C 00    ................
00000200: 17 00 15 00 18 00 18 00 19 00 24 00 1A 00 01 00    ..........$.....
00000210: 13 00 00 00 02 00 14                               .......

</code></pre></div></div>

<p>看下他的数据结构定义</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
ClassFile {
    u4             magic;  # 对应 CA FE BA BE,二进制字节码魔数 Magic。  在elf格式中也存在这样的模式,作用是区分二进制文件类型
    u2             minor_version; # 副版本
    u2             major_version; # 主版本
    u2             constant_pool_count;
    cp_info        constant_pool[constant_pool_count-1];
    u2             access_flags;
    u2             this_class;
    u2             super_class;
    u2             interfaces_count;
    u2             interfaces[interfaces_count];
    u2             fields_count;
    field_info     fields[fields_count];
    u2             methods_count;
    method_info    methods[methods_count];
    u2             attributes_count;
    attribute_info attributes[attributes_count];
}

</code></pre></div></div>

<p>从上面数据结构上看,一个classfile要解析到内存,供JIT或者Intepreter使用,至少要做以下几件事:</p>

<ul>
  <li>
    <p>谁来负责解析？ 解析的顺序是什么？</p>
  </li>
  <li>
    <p>把类型的元信息、字面量加载到相应区域(调试情况),比如class name, fileds name, function name 等</p>
  </li>
  <li>
    <p>从Main函数启动主线程后,需要一个角色来驱动指令的往前推进,这是很重要的一步</p>
  </li>
  <li>
    <p>JVM指令的翻译需要精确的上下文,比如堆上对象的引用,如何计算fields相对于instance的偏移？</p>
  </li>
  <li>
    <p>函数是按需加载还是热加载？link的机制是什么？</p>
  </li>
</ul>

<p>先来看一个有趣的问题。</p>

<blockquote>
  <p>who will load the loader?</p>
</blockquote>

<p>谁来负责加载根加载器本身?</p>

<p>答案是bootstrap classloader本身是平台相关的一部分,它不是java实现的</p>

<p>看下loader在加载过程中的位置</p>

<p><img src="http://blog.h5tube.com/loader.png" alt="jvm bootstrap loader" /></p>

<ul>
  <li>Bootstrap class loader</li>
</ul>

<p>这个功能在openjdk源码中的定义位置</p>

<blockquote>
  <p>/jdk-8-hotspot/agent/src/share/classes/sun/jvm/hotspot/jdi/VirtualMachineImpl.java</p>
</blockquote>

<p>代码片段如下:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        javaLangString = st.probe("java/lang/String");
        javaLangThread = st.probe("java/lang/Thread");
        javaLangThreadGroup = st.probe("java/lang/ThreadGroup");
        javaLangClass = st.probe("java/lang/Class");
        javaLangClassLoader = st.probe("java/lang/ClassLoader");
        javaLangThrowable = st.probe("java/lang/Throwable");
        javaLangObject = st.probe("java/lang/Object");
        javaLangCloneable = st.probe("java/lang/Cloneable");
        javaIoSerializable = st.probe("java/io/Serializable");
        javaLangEnum = st.probe("java/lang/Enum");
</code></pre></div></div>

<p>它实现了String、Thread、ThreadGroup、Class、ClassLoader、Throwable、Object、Cloneable、Serializable、Enum</p>

<p>这些class对象是把其它class文件映射到内存的基础, 包括下面的Ext class loader、System class loader。</p>

<ul>
  <li>Ext class loader、System class loader</li>
</ul>

<p>classLoaderExt.hpp 的定义位置, 负责加载jre/lib下的库文件</p>

<blockquote>
  <p>/jdk-8-hotspot/src/share/vm/classfile/classLoaderExt.hpp</p>
</blockquote>

<p>Loader 使用父辈委托代理模型(当有load请求时,直接委托), 当上面的Loader也找不到时, 子辈再亲自查找, 最后无法找到时抛出异常信息。</p>

<p><img src="http://blog.h5tube.com/jvmclassloader.jpg" alt="jvm loader" /></p>

<p><img src="http://blog.h5tube.com/loader-s.png" alt="ext class loader" /></p>

<p>码字不易,转载注明出处。</p>

<p>下一篇文章 TODO: JVM中的函数调用模型</p>


                </div>
            </section>
            <!-- Email subscribe form at the bottom of the page -->
            
            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- /author  -->
            </footer>
            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
        </article>
    </div>
</main>
<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; 张庆华的个人日志 &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/jvm/">Jvm</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/event-based-archi">消息中间件-RabbitMQ应用模式解析(二)</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/springboot-how-bean-managed">spring中的100个问题-bean是被透明化管理的?</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/jvm-jmm">JVM内部机制(七) Java内存模型(Java Momory Model)</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/jvm/">
                                
                                    See all 23 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            
            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card distribution">
        
            <a class="post-card-image-link" href="/jvm-method-call">
                <div class="post-card-image" style="background-image: url(/assets/images/spring_java8.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/jvm-method-call">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Jvm</span>
                            
                        
                    

                    <h2 class="post-card-title">JVM内部机制(二)Java方法调用</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            
            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card devops no-image">
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/devops-automation">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Automation</span>
                            
                        
                    

                    <h2 class="post-card-title">自动化测试工具篇-cucumber</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            
        </div>
    </div>
</aside>
<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="http://localhost:4000/">
            
                <img src="/assets/images/favicon.png" alt="张庆华的个人日志 icon" />
            
            <span>张庆华的个人日志</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">JVM内部机制(一)加载字节码</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=JVM%E5%86%85%E9%83%A8%E6%9C%BA%E5%88%B6%28%E4%B8%80%29%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81&amp;url=https://rmrfself.github.io/jvm-class-loader"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://rmrfself.github.io/jvm-class-loader"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>

<!-- /post -->
<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        
        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="my_profile">
                    <a href='#' class='ava'><img src='http://blog.h5tube.com/me.jpg' /></a>
                    <div class='profile_detail'>
                        <h4>About me</h4>
                        <p>My name is Zhang QingHua(张庆华). Foreign friends call me Mike. I was born in 1980s.</p>
                        <p>I am an IT developer focusing on web technology(PC and Mobile). Now i am employed by one of vendor of Rakuten.com as a software archtect at Dalian(大连).</p>
                        <p>I graduated from ShanDong University in July 2006 with a computer science degree.</p>
                        <p>In my spare time, i like swimming, hiking in the wild and learning in Youtube.com.</p>
                        <p>Last updated at: 2017/12/12</p>
                    </div>
                </section>
            </div>
            <p class="copyright inner"><a href="http://localhost:4000/">张庆华的个人日志</a> &copy; 2012年6月 | 微信: xanderQ</p>
        </footer>
    </div>

    <!-- The big email subscribe modal content -->
    
    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->
    
    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-126286097-1', 'auto');
  ga('send', 'pageview');

 </script>

    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->
</body>
</html>
